#!/bin/bash

#Unfinished version of bash script (bn)

#local usage function
usage(){
    echo "bn <year> <assigned gender f|F|m|M|b|B>"
    exit 1
}

#local help function
help(){
    echo "output help messages ..."
    exit 0
}

birthYear=$1
birthGender=$2
dataFile="us_baby_names/yob${birthYear}.txt"

if [[ $# -gt 2 || $# -lt 2 ]]
then
    usage
fi

if [[ $birthYear =~ ^[0-9]{4}$ ]] 
then
    true
else
    echo "Badly formatted year: $birthYear"
    usage
fi

if [[ $birthGender =~ ^[FfMmBb]$ ]] 
then
    true
else
    echo "Badly formatted assigned gender: $birthGender"
    usage
fi


if [[ -f $dataFile ]]
then
    true
else
    usage
fi

#local rank function
rank(){
    local name=$1

    if [[ $name =~ ^[A-Za-z]+ ]]
    then
        if [[ $birthGender = "M" || $birthGender = "m" ]]
        then
            if [[ $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | grep -n -P -i -w "$name,M,[0-9]+" | grep -P -o "^[0-9]+") = "" ]]
            then
                echo "$birthYear: $name not found among the male names."
            else
                echo "$birthYear: $name ranked $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | grep -n -P -i -w "$name,M,[0-9]+" | grep -P -o "^[0-9]+") out of $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | wc -l) male names."
            fi
        elif [[ $birthGender = "F" || $birthGender = "f" ]]
        then
            if [[ $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | grep -n -P -i -w "$name,F,[0-9]+" | grep -P -o "^[0-9]+") = "" ]]
            then
                echo "$birthYear: $name not found among the female names."
            else
                echo "$birthYear: $name ranked $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | grep -n -P -i -w "$name,F,[0-9]+" | grep -P -o "^[0-9]+") out of $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | wc -l) female names."
            fi
        else
            if [[ $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | grep -n -P -i -w "$name,M,[0-9]+" | grep -P -o "^[0-9]+") = "" && $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | grep -n -P -i -w "$name,F,[0-9]+" | grep -P -o "^[0-9]+") = "" ]]
            then
                echo "$birthYear: $name not found among male names"
                echo "$birthYear: $name not found among female names"
            elif [[ $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | grep -n -P -i -w "$name,M,[0-9]+" | grep -P -o "^[0-9]+") = "" ]]
            then
                echo "$birthYear: $name not found among the male names."
                echo "$birthYear: $name ranked $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | grep -n -P -i -w "$name,F,[0-9]+" | grep -P -o "^[0-9]+") out of $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | wc -l) female names."
            elif [[ $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | grep -n -P -i -w "$name,F,[0-9]+" | grep -P -o "^[0-9]+") = "" ]]
            then
                echo "$birthYear: $name ranked $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | grep -n -P -i -w "$name,M,[0-9]+" | grep -P -o "^[0-9]+") out of $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | wc -l) male names."
                echo "$birthYear: $name not found among the female names."
            else
                echo "$birthYear: $name ranked $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | grep -n -P -i -w "$name,M,[0-9]+" | grep -P -o "^[0-9]+") out of $(cat $dataFile | grep -P -i "^[A-Z]+,M,[0-9]+" | wc -l) male names."
                echo "$birthYear: $name ranked $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | grep -n -P -i -w "$name,F,[0-9]+" | grep -P -o "^[0-9]+") out of $(cat $dataFile | grep -P -i "^[A-Z]+,F,[0-9]+" | wc -l) female names."
            fi
        fi
    else
        echo "Badly formatted name: $name"
    fi
}

while read line
do
    for allNames in $line
    do
        rank $allNames
    done
done